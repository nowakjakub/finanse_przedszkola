<!doctype html>
<html lang="pl" class="h-full">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Finanse grupy przedszkolnej</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind dark mode support
        if (
            localStorage.getItem('theme') === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        :root {
            color-scheme: light dark;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.6);
        }

        .glass-dark {
            backdrop-filter: blur(10px);
            background: rgba(17, 24, 39, 0.6);
        }
    </style>
</head>

<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header
            class="sticky top-0 z-40 border-b border-gray-200/60 dark:border-gray-800/60 bg-white/70 dark:bg-gray-900/70 glass dark:glass-dark">
            <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h11v2H3v-2zm0 4h11v2H3v-2zm0 4h18v2H3v-2z" />
                    </svg>
                    <h1 class="text-lg font-semibold">Finanse grupy</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="darkToggle"
                        class="px-3 py-1.5 text-sm rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">
                        <span class="inline dark:hidden">üåô Tryb ciemny</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è Tryb jasny</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="flex-1">
            <section class="max-w-3xl mx-auto p-4">
                <!-- Info cards -->
                <div id="accountSummary"
                    class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 opacity-0 transition-opacity"></div>

                <!-- Search -->
                <div class="mb-4">
                    <label for="journalNo" class="block text-sm font-medium mb-1">Numer z dziennika</label>
                    <div class="flex gap-2">
                        <input id="journalNo" type="text" inputmode="numeric" placeholder="np. 12 lub A12"
                            class="flex-1 rounded-xl px-3 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
                        <button id="checkBtn"
                            class="rounded-xl px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white">Sprawd≈∫</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Wpisz numer dziecka z dziennika, aby zobaczyƒá status op≈Çat.
                        Dane sƒÖ anonimowe ‚Äì brak imion i nazwisk.</p>
                </div>

                <!-- Result -->
                <div id="result" class="space-y-4"></div>

                <!-- Expenses list -->
                <div id="expensesWrap" class="mt-8 hidden">
                    <h2 class="text-base font-semibold mb-2">Wydatki (publiczne podsumowanie)</h2>
                    <div id="expenses" class="space-y-2"></div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="border-t border-gray-200/60 dark:border-gray-800/60 py-4 text-center text-xs text-gray-500">
            <div class="max-w-3xl mx-auto px-4">

                <p>Przyk≈Çadowa aplikacja statyczna. Dane sƒÖ szyfrowane po stronie klienta i odblokowywane za pomocƒÖ
                    PIN-u.</p>
            </div>
        </footer>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
        <div
            class="w-full max-w-sm rounded-2xl p-6 shadow-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold mb-2">Podaj PIN, aby wczytaƒá dane</h2>
            <p class="text-sm text-gray-500 mb-4">To proste zabezpieczenie przed ciekawskimi. Nie wpisuj tu hase≈Ç
                u≈ºywanych gdzie indziej.</p>
            <div class="space-y-3">
                <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN"
                    class="w-full rounded-xl px-3 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
                <button id="unlockBtn"
                    class="w-full rounded-xl px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white">Odblokuj</button>
                <p id="pinError" class="text-sm text-red-500 hidden">Nieprawid≈Çowy PIN lub dane. Spr√≥buj ponownie.</p>
            </div>
            <p class="text-[11px] text-gray-500 mt-4">Uwaga: w statycznych stronach PIN to tylko utrudnienie dostƒôpu.
                Nie publikuj danych wra≈ºliwych (imion, adres√≥w, PESEL). U≈ºywaj samych numer√≥w z dziennika i kwot.</p>
        </div>
    </div>

    <script>
        // ---- Utility: currency ----
        const fmt = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' })

        // ---- Theme toggle ----
        document.getElementById('darkToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark')
            localStorage.setItem('theme', isDark ? 'dark' : 'light')
        })

        // ---- Crypto helpers (WebCrypto) ----
        async function deriveKey(pin, salt, iterations = 120000) {
            const enc = new TextEncoder()
            const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), { name: 'PBKDF2' }, false, ['deriveKey'])
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            )
        }

        async function decryptData(pin, payload) {
            // payload: { salt: base64, iv: base64, ct: base64, iterations?: number }
            const salt = Uint8Array.from(atob(payload.salt), c => c.charCodeAt(0))
            const iv = Uint8Array.from(atob(payload.iv), c => c.charCodeAt(0))
            const ct = Uint8Array.from(atob(payload.ct), c => c.charCodeAt(0))
            const key = await deriveKey(pin, salt, payload.iterations || 120000)
            const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct)
            const txt = new TextDecoder().decode(new Uint8Array(pt))
            return JSON.parse(txt)
        }

        // ---- State ----
        let DATA = null // decrypted JSON

        // ---- DOM refs ----
        const pinModal = document.getElementById('pinModal')
        const pinInput = document.getElementById('pinInput')
        const unlockBtn = document.getElementById('unlockBtn')
        const pinError = document.getElementById('pinError')

        const summaryEl = document.getElementById('accountSummary')
        const resultEl = document.getElementById('result')
        const expensesWrap = document.getElementById('expensesWrap')
        const expensesEl = document.getElementById('expenses')

        // ---- Load encrypted payload ----
        let ENCRYPTED_PAYLOAD = null
        async function fetchEncrypted() {
            // Place your encrypted file at ./data.enc.json
            const res = await fetch('./data.enc.json', { cache: 'no-store' })
            if (!res.ok) throw new Error('Nie mo≈ºna pobraƒá danych')
            ENCRYPTED_PAYLOAD = await res.json()
        }

        // ---- Renderers ----
        function renderSummary() {
            const { account, fees } = DATA
            summaryEl.innerHTML = `
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="text-xs text-gray-500">Stan konta</div>
          <div class="text-2xl font-semibold">${fmt.format(account.balance)}</div>
          <div class="text-xs text-gray-500 mt-1">Aktualizacja: ${account.lastUpdate}</div>
        </div>
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="text-xs text-gray-500">Bie≈ºƒÖca sk≈Çadka</div>
          <div class="text-lg font-medium">${fees.currentPeriod} ‚Ä¢ ${fmt.format(fees.amountDue)}</div>
          <div class="text-xs text-gray-500 mt-1">${fees.description || ''}</div>
        </div>`
            summaryEl.style.opacity = 1
        }

        function renderChildStatus(entry) {
            resultEl.innerHTML = ''
            if (!entry) {
                resultEl.innerHTML = `<div class="rounded-2xl border border-amber-300 bg-amber-50 text-amber-900 dark:border-amber-400/40 dark:bg-amber-950/30 dark:text-amber-100 p-4">
          Nie znaleziono takiego numeru. Sprawd≈∫ wpis.
        </div>`
                return
            }

            const paidBadge = entry.paid
                ? `<span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">OP≈ÅACONO</span>`
                : `<span class="px-2 py-0.5 text-xs rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">DO ZAP≈ÅATY</span>`

            const allocations = (entry.allocations || [])
                .map(a => `<div class="flex justify-between text-sm"><span>${a.purpose}</span><span>${fmt.format(a.amount)}</span></div>`)
                .join('') || '<div class="text-sm text-gray-500">Brak alokacji</div>'

            const receipts = (entry.receipts || [])
                .map(url => `<a class="text-blue-600 dark:text-blue-400 underline" href="${url}" target="_blank" rel="noreferrer">Paragon</a>`)
                .join(' ¬∑ ') || '<span class="text-gray-500">Brak paragon√≥w</span>'

            const dueInfo = entry.paid
                ? `<div class="text-sm text-gray-500">Zap≈Çacono: <strong>${fmt.format(entry.amountPaid || 0)}</strong> ${entry.paidOn ? `(${entry.paidOn})` : ''}</div>`
                : `<div class="text-sm text-gray-500">Do zap≈Çaty: <strong>${fmt.format((DATA.fees?.amountDue || 0) - (entry.amountPaid || 0))}</strong></div>`

            resultEl.innerHTML = `
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">Numer: ${entry.journalNo}</div>
            ${paidBadge}
          </div>
          <div class="mt-2 space-y-1">
            ${dueInfo}
            <div class="text-sm">Na co przeznaczono / przeznaczy siƒô ≈õrodki:</div>
            <div class="mt-1 space-y-0.5">${allocations}</div>
            <div class="mt-2 text-sm">Paragony: ${receipts}</div>
          </div>
        </div>`
        }

        function renderExpenses() {
            const items = DATA.expenses || []
            if (!items.length) { expensesWrap.classList.add('hidden'); return }
            expensesWrap.classList.remove('hidden')
            expensesEl.innerHTML = items.map(e => `
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between text-sm">
            <div class="font-medium">${e.purpose}</div>
            <div>${fmt.format(e.amount)}</div>
          </div>
          <div class="text-xs text-gray-500">${e.date || ''}</div>
          ${e.receipt ? `<a class=\"text-xs text-blue-600 dark:text-blue-400 underline\" href=\"${e.receipt}\" target=\"_blank\" rel=\"noreferrer\">Paragon</a>` : ''}
        </div>`).join('')
        }

        // ---- Events ----
        document.getElementById('checkBtn').addEventListener('click', () => {
            const val = (document.getElementById('journalNo').value || '').trim()
            if (!val) return
            const entry = (DATA.entries || []).find(e => (e.journalNo + '').toLowerCase() === val.toLowerCase())
            renderChildStatus(entry)
        })

        // Enter on PIN or on search
        pinInput.addEventListener('keydown', e => { if (e.key === 'Enter') unlockBtn.click() })
        document.getElementById('journalNo').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('checkBtn').click() })

        unlockBtn.addEventListener('click', async () => {
            pinError.classList.add('hidden')
            const pin = pinInput.value
            if (!pin) return
            try {
                if (!ENCRYPTED_PAYLOAD) await fetchEncrypted()
                DATA = await decryptData(pin, ENCRYPTED_PAYLOAD)
                pinModal.remove()
                renderSummary()
                renderExpenses()
            } catch (e) {
                console.error(e)
                pinError.classList.remove('hidden')
            }
        })

        // Optional: auto-focus
        setTimeout(() => pinInput.focus(), 100)

    </script>
</body>

</html>