<!DOCTYPE html>
<html lang="pl" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sk≈Çadki przedszkolne ‚Äì podglƒÖd wp≈Çat</title>
    <meta name="description"
        content="Prosta strona dla rodzic√≥w do sprawdzania wp≈Çat i wydatk√≥w grupy przedszkolnej. Dzia≈Ça na GitHub Pages.">
    <style>
        :root {
            --bg: #0b0e11;
            --card: #12161c;
            --muted: #9aa4b2;
            --text: #e5e7eb;
            --accent: #6ee7b7;
            --danger: #fda4af;
            --warn: #fde68a;
            --link: #93c5fd;
            --ring: #2563eb;
            --ok: #34d399;
            --border: #1f2937;
        }

        [data-theme="light"] {
            --bg: #f6f7fb;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #475569;
            --accent: #059669;
            --danger: #b91c1c;
            --warn: #b45309;
            --link: #1d4ed8;
            --ring: #2563eb;
            --ok: #047857;
            --border: #e5e7eb;
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 16px/1.45 system-ui, Segoe UI, Roboto, Ubuntu, Inter, sans-serif
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 16px
        }

        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px
        }

        @media(min-width:900px) {
            .row {
                grid-template-columns: 1.2fr .8fr
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 1px 0 rgba(255, 255, 255, .03), 0 12px 24px rgba(0, 0, 0, .25)
        }

        h1 {
            font-size: clamp(1.4rem, 2.5vw, 2rem);
            margin: 0 0 6px
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 8px
        }

        .muted {
            color: var(--muted)
        }

        .pill {
            display: inline-block;
            padding: .3rem .6rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .03);
            font-size: .85rem
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px
        }

        .stat {
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), transparent)
        }

        .stat .v {
            font-weight: 700;
            font-size: 1.1rem
        }

        .flex {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        .right {
            margin-left: auto
        }

        button,
        input,
        select {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            padding: 10px 12px;
            font: inherit
        }

        input:focus,
        button:focus {
            outline: 2px solid var(--ring);
            outline-offset: 2px
        }

        a {
            color: var(--link)
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0
        }

        .table th,
        .table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            text-align: left
        }

        .badge {
            padding: .25rem .5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: .8rem
        }

        .ok {
            color: var(--ok)
        }

        .danger {
            color: var(--danger)
        }

        .warn {
            color: var(--warn)
        }

        .hidden {
            display: none
        }

        .footer {
            margin-top: 20px;
            color: var(--muted);
            font-size: .9rem
        }

        .progress {
            height: 10px;
            background: rgba(255, 255, 255, .06);
            border-radius: 999px;
            overflow: hidden
        }

        .progress>span {
            display: block;
            height: 100%;
            background: var(--accent)
        }

        .search-area {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 8px
        }

        @media(min-width:600px) {
            .search-area {
                grid-template-columns: 220px 120px auto
            }
        }

        .kicker {
            font-size: .9rem;
            color: var(--muted)
        }

        code {
            background: rgba(255, 255, 255, .06);
            padding: .1rem .35rem;
            border-radius: 6px;
            border: 1px solid var(--border)
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="flex" style="gap:10px;margin-bottom:14px">
            <div>
                <h1>Sk≈Çadki przedszkolne</h1>
                <div class="kicker" id="kicker"></div>
            </div>
            <div class="right flex">
                <button id="themeBtn" title="Prze≈ÇƒÖcz motyw">üåó Motyw</button>
                <button id="shareBtn" title="Udostƒôpnij link z zakodowanymi danymi">üîó Udostƒôpnij</button>
            </div>
        </header>

        <section class="row">
            <div class="card">
                <div class="flex" style="justify-content:space-between;align-items:flex-start">
                    <div>
                        <h2>Stan konta i zbi√≥rki</h2>
                        <div class="muted" id="updated"></div>
                    </div>
                    <div id="currentBadge" class="pill">‚Äî</div>
                </div>

                <div class="grid-3" style="margin-top:10px">
                    <div class="stat">
                        <div class="muted">Stan poczƒÖtkowy (sumy czƒÖstkowe)</div>
                        <div class="v" id="openingSum">‚Äî</div>
                    </div>
                    <div class="stat">
                        <div class="muted">Wydatki ≈ÇƒÖcznie</div>
                        <div class="v" id="expensesSum">‚Äî</div>
                    </div>
                    <div class="stat">
                        <div class="muted">Stan bie≈ºƒÖcy</div>
                        <div class="v" id="balanceNow">‚Äî</div>
                    </div>
                </div>

                <div style="margin-top:16px">
                    <div class="flex" style="justify-content:space-between;align-items:center">
                        <div>
                            <div class="muted">Aktualna zbi√≥rka</div>
                            <div style="font-weight:700" id="currentTitle">‚Äî</div>
                        </div>
                        <div class="pill" id="currentStats">‚Äî</div>
                    </div>
                    <div class="progress" style="margin-top:8px"><span id="currentProgress" style="width:0%"></span>
                    </div>
                </div>

                <div style="margin-top:16px">
                    <div class="muted" style="margin-bottom:6px">Sumy czƒÖstkowe</div>
                    <div id="partials" class="flex" style="gap:8px;flex-wrap:wrap"></div>
                </div>
            </div>

            <div class="card">
                <h2>Sprawd≈∫ swojƒÖ wp≈Çatƒô</h2>
                <div class="search-area">
                    <input id="kidNumber" type="number" min="1" max="25" placeholder="Numer z dziennika (1‚Äì25)" />
                    <button id="checkBtn">Sprawd≈∫</button>
                    <div id="checkMsg" class="muted"></div>
                </div>
                <div id="arrearsBox" class="hidden" style="margin-top:10px"></div>
                <div style="margin-top:12px" class="muted">Zakres numer√≥w jest walidowany i mo≈ºe wynosiƒá tylko od
                    <b>1</b> do <b id="maxKids">25</b>.
                </div>
            </div>
        </section>

        <section class="card" style="margin-top:16px">
            <h2>Wydatki</h2>
            <table class="table" id="expensesTable">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Opis</th>
                        <th>Kwota</th>
                        <th>Dow√≥d</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="muted" id="noExpenses" style="display:none">Brak wydatk√≥w.</div>
        </section>

        <section class="card" style="margin-top:16px">
            <h2>Poprzednie zbi√≥rki</h2>
            <div id="pastCollections"></div>
        </section>

        <section class="card" style="margin-top:16px">
            <h2>Dane do wp≈Çat</h2>
            <div id="paymentInfo"></div>
        </section>

        <div class="footer">Dane aktualizowane przez plik <code>data.json</code> lub zakodowane w adresie URL. Ta strona
            nie zbiera ≈ºadnych danych o u≈ºytkownikach.</div>
    </div>

    <!--
    üîß JAK ZASILAƒÜ DANYMI (3 opcje, priorytet od 1 do 3):
    1) URL: dodaj ?data=<BASE64_JSON> do adresu strony (np. przez przycisk ‚ÄûUdostƒôpnij‚Äù).
    2) Plik data.json w tym samym katalogu (GitHub Pages: po prostu wrzuƒá plik do repo; wra≈ºliwe repo ‚Äì u≈ºyj Branch/PR).
    3) Wbudowane dane rezerwowe w <script id="embeddedData"> poni≈ºej.

    Dziƒôki temu mo≈ºesz trzymaƒá dane poza historiƒÖ commit√≥w (np. w osobnym branchu) lub generowaƒá link z zaszyfrowanymi/zakodowanymi danymi.
  -->
    <script id="embeddedData" type="application/json">
  {
    "meta": {"group": "Grupa ≈ªabki", "currency": "PLN", "updated": "2025-09-29"},
    "children": {"min": 1, "max": 25},
    "balances": [
      {"label": "klasowe", "amount": 1100.00},
      {"label": "z ksiƒÖ≈ºek", "amount": 18.50},
      {"label": "z zesz≈Çego roku", "amount": 345.46}
    ],
    "collections": [
      {
        "id": "klasowe-2025",
        "title": "Klasowe (50 z≈Ç/os.)",
        "type": "per_child",
        "amount_per_child": 50.00,
        "range": {"from": 1, "to": 25},
        "paid_numbers": [1,2,4,5,6,8,9,10,11,13,14,15,16,17,18,19,20,21,22,23,24,25],
        "status": "open",
        "is_current": true
      }
    ],
    "expenses": [
      {"date":"2025-09-20","title":"Materia≈Çy plastyczne","amount":120.00,"receipt_url":"https://example.com/paragon-2025-09-20.jpg"},
      {"date":"2025-09-15","title":"Woda na piknik","amount":35.99,"note":"Paragon zagubiony przez dostawcƒô"}
    ],
    "payment_info": {
      "recipient": "Rada Rodzic√≥w ‚Äì Grupa Kaczuszki",
      "account": "12 3456 7890 1234 5678 9012 3456",
      "blik": "886508106",
      "title_example": "Klasowe, nr 5, Jan Kowalski"
    }
  }
  </script>

    <script>
        (function () {
            const byId = (id) => document.getElementById(id);

            // THEME
            const themeBtn = byId('themeBtn');
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); }
            themeBtn.addEventListener('click', () => {
                const cur = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', cur);
                localStorage.setItem('theme', cur);
            });

            // DATA LOADING STRATEGY: URL ?data=BASE64 > data.json > embedded
            async function loadData() {
                const url = new URL(window.location.href);
                const encoded = url.searchParams.get('data');
                if (encoded) {
                    try { return JSON.parse(atob(encoded)); } catch (e) { console.warn('Niepoprawny BASE64 JSON w URL', e); }
                }
                try {
                    const r = await fetch('data.json', { cache: 'no-store' });
                    if (r.ok) { return await r.json(); }
                } catch (e) { /* ignore */ }
                try {
                    return JSON.parse(byId('embeddedData').textContent);
                } catch (e) { alert('B≈ÇƒÖd w danych wbudowanych.'); throw e; }
            }

            function z(n) { return new Intl.NumberFormat('pl-PL', { style: 'currency', currency: data.meta?.currency || 'PLN' }).format(n); }

            // SHARE current data as ?data=BASE64
            const shareBtn = byId('shareBtn');
            shareBtn.addEventListener('click', async () => {
                const base = location.origin + location.pathname + '?data=' + btoa(JSON.stringify(data));
                await navigator.clipboard.writeText(base);
                alert('Skopiowano link z danymi do schowka.');
            });

            let data = null;

            function validateKidNumber(n) {
                const min = data.children?.min ?? 1;
                const max = data.children?.max ?? 25;
                if (!Number.isInteger(n) || n < min || n > max) return { ok: false, msg: `Podaj numer ${min}‚Äì${max}.` };
                return { ok: true, msg: '' };
            }

            function computeOpeningSum() {
                return (data.balances || []).reduce((s, x) => s + Number(x.amount || 0), 0);
            }
            function computeExpensesSum() {
                return (data.expenses || []).reduce((s, x) => s + Number(x.amount || 0), 0);
            }

            function renderTop() {
                byId('kicker').textContent = data.meta?.group || '';
                byId('updated').textContent = `Ostatnia aktualizacja: ${data.meta?.updated || '‚Äî'}`;

                // Opening, expenses, now
                const opening = computeOpeningSum();
                const expSum = computeExpensesSum();
                const now = opening - expSum;
                byId('openingSum').textContent = z(opening);
                byId('expensesSum').textContent = z(expSum);
                byId('balanceNow').textContent = z(now);

                // Partials
                const wrap = byId('partials');
                wrap.innerHTML = '';
                (data.balances || []).forEach(b => {
                    const el = document.createElement('div');
                    el.className = 'pill';
                    el.textContent = `${b.label}: ${z(Number(b.amount || 0))}`;
                    wrap.appendChild(el);
                });

                // Current collection
                const cur = (data.collections || []).find(c => c.is_current) || null;
                const maxKids = (data.children?.max ?? 25);
                byId('maxKids').textContent = maxKids;
                if (cur) {
                    byId('currentBadge').textContent = cur.status === 'open' ? 'zbi√≥rka otwarta' : 'zako≈Ñczona';
                    byId('currentTitle').textContent = cur.title;
                    const totalExpected = (cur.range?.to - cur.range?.from + 1) * Number(cur.amount_per_child || 0);
                    const paidCount = (cur.paid_numbers || []).length;
                    const paidAmt = paidCount * Number(cur.amount_per_child || 0);
                    const pct = totalExpected > 0 ? Math.round(100 * paidAmt / totalExpected) : 0;
                    byId('currentStats').textContent = `${paidCount}/${cur.range?.to} op≈Çaconych ‚Ä¢ ${z(paidAmt)} / ${z(totalExpected)}`;
                    byId('currentProgress').style.width = pct + '%';
                } else {
                    byId('currentBadge').textContent = 'brak aktywnej zbi√≥rki';
                    byId('currentTitle').textContent = '‚Äî';
                    byId('currentStats').textContent = '‚Äî';
                    byId('currentProgress').style.width = '0%';
                }
            }

            function renderExpenses() {
                const tbody = byId('expensesTable').querySelector('tbody');
                tbody.innerHTML = '';
                const arr = (data.expenses || []).slice().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                if (arr.length === 0) { byId('noExpenses').style.display = 'block'; return; }
                byId('noExpenses').style.display = 'none';
                for (const e of arr) {
                    const tr = document.createElement('tr');
                    const linkCell = (() => {
                        if (e.receipt_url) { return `<a href="${e.receipt_url}" target="_blank" rel="noopener">paragon</a>`; }
                        if (e.note) { return `<span class="warn">${e.note}</span>`; }
                        return '<span class="muted">brak danych</span>';
                    })();
                    tr.innerHTML = `<td>${e.date || ''}</td><td>${e.title || ''}</td><td>${z(Number(e.amount || 0))}</td><td>${linkCell}</td>`;
                    tbody.appendChild(tr);
                }
            }

            function renderPastCollections() {
                const box = byId('pastCollections');
                box.innerHTML = '';
                const past = (data.collections || []).filter(c => !c.is_current);
                if (past.length === 0) { box.innerHTML = '<div class="muted">Brak wcze≈õniejszych zbi√≥rek.</div>'; return; }
                const tbl = document.createElement('table'); tbl.className = 'table';
                tbl.innerHTML = '<thead><tr><th>Nazwa</th><th>Status</th><th>Kwota zebrana</th><th>Oczekiwana</th><th>Pokrycie</th></tr></thead>';
                const tb = document.createElement('tbody');
                for (const c of past) {
                    const expected = (c.range?.to - c.range?.from + 1) * Number(c.amount_per_child || 0);
                    const paid = (c.paid_numbers || []).length * Number(c.amount_per_child || 0);
                    const pct = expected > 0 ? Math.round(100 * paid / expected) : 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${c.title}</td><td>${c.status || '-'}</td><td>${z(paid)}</td><td>${z(expected)}</td><td>${pct}%</td>`;
                    tb.appendChild(tr);
                }
                tbl.appendChild(tb); box.appendChild(tbl);
            }

            function searchKid(num) {
                // Validate 1..max
                const v = validateKidNumber(num);
                const out = byId('checkMsg');
                const arrearsBox = byId('arrearsBox');
                arrearsBox.classList.add('hidden'); arrearsBox.innerHTML = '';
                if (!v.ok) { out.innerHTML = `<span class="danger">${v.msg}</span>`; return; }
                const openCollections = (data.collections || []).filter(c => (c.status || 'open') === 'open');
                let totalArrears = 0;
                const lines = [];
                for (const c of openCollections) {
                    const paid = (c.paid_numbers || []).includes(num);
                    if (!paid) {
                        const due = Number(c.amount_per_child || 0);
                        totalArrears += due;
                        lines.push(`<li>${c.title}: <b>${z(due)}</b> (brak wp≈Çaty)</li>`);
                    } else {
                        lines.push(`<li>${c.title}: <span class="ok">wp≈Çacono</span></li>`);
                    }
                }
                if (openCollections.length === 0) {
                    out.innerHTML = '<span class="ok">Brak otwartych zbi√≥rek.</span>';
                    return;
                }
                if (totalArrears === 0) {
                    out.innerHTML = '<span class="ok">Wszystko op≈Çacone. Dziƒôkujemy! üéâ</span>';
                } else {
                    out.innerHTML = `<span class="warn">Zaleg≈Ço≈õƒá ≈ÇƒÖczna: <b>${z(totalArrears)}</b></span>`;
                }
                arrearsBox.classList.remove('hidden');
                arrearsBox.innerHTML = `<ul style="margin:0;padding-left:18px">${lines.join('')}</ul>`;
            }

            // Bind search
            byId('checkBtn').addEventListener('click', () => {
                const n = Number(byId('kidNumber').value);
                searchKid(n | 0);
            });
            byId('kidNumber').addEventListener('keydown', (e) => { if (e.key === 'Enter') { byId('checkBtn').click(); } });

            // INIT
            loadData().then(json => { data = json; renderTop(); renderExpenses(); renderPastCollections(); });
        })();
    </script>
</body>

</html>