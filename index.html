<!doctype html>
<html lang="pl" class="h-full">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Finanse grupy przedszkolnej</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind dark mode support
        if (
            localStorage.getItem('theme') === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        :root {
            color-scheme: light dark;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.6);
        }

        .glass-dark {
            backdrop-filter: blur(10px);
            background: rgba(17, 24, 39, 0.6);
        }
    </style>
</head>

<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header
            class="sticky top-0 z-40 border-b border-gray-200/60 dark:border-gray-800/60 bg-white/70 dark:bg-gray-900/70 glass dark:glass-dark">
            <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h11v2H3v-2zm0 4h11v2H3v-2zm0 4h18v2H3v-2z" />
                    </svg>
                    <h1 class="text-lg font-semibold">Finanse grupy</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="darkToggle"
                        class="px-3 py-1.5 text-sm rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">
                        <span class="inline dark:hidden">üåô Tryb ciemny</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è Tryb jasny</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="flex-1">
            <section class="max-w-3xl mx-auto p-4">
                <!-- Info cards -->
                <div id="accountSummary"
                    class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 opacity-0 transition-opacity"></div>

                <!-- Search -->
                <div class="mb-4">
                    <label for="journalNo" class="block text-sm font-medium mb-1">Numer z dziennika</label>
                    <div class="flex gap-2">
                        <input id="journalNo" type="text" inputmode="numeric" placeholder="np. 12 lub A12"
                            class="flex-1 rounded-xl px-3 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
                        <button id="checkBtn"
                            class="rounded-xl px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white">Sprawd≈∫</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Wpisz numer dziecka z dziennika, aby zobaczyƒá status op≈Çat.
                        Dane sƒÖ anonimowe ‚Äì brak imion i nazwisk.</p>
                </div>

                <!-- Result -->
                <div id="result" class="space-y-4"></div>

                <!-- History -->
                <div id="historyWrap" class="mt-8 hidden">
                    <h2 class="text-base font-semibold mb-2">Historia (najnowsze ‚Üí najstarsze)</h2>
                    <div id="history" class="space-y-2"></div>
                </div>

                <!-- Expenses list -->
                <div id="expensesWrap" class="mt-8 hidden">
                    <h2 class="text-base font-semibold mb-2">Wydatki (publiczne podsumowanie)</h2>
                    <div id="expenses" class="space-y-2"></div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="border-t border-gray-200/60 dark:border-gray-800/60 py-4 text-center text-xs text-gray-500">
            <div class="max-w-3xl mx-auto px-4">

                <p>Przyk≈Çadowa aplikacja statyczna. Dane sƒÖ szyfrowane po stronie klienta i odblokowywane za pomocƒÖ
                    PIN-u.</p>
            </div>
        </footer>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
        <div
            class="w-full max-w-sm rounded-2xl p-6 shadow-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold mb-2">Podaj PIN, aby wczytaƒá dane</h2>
            <p class="text-sm text-gray-500 mb-4">To proste zabezpieczenie przed ciekawskimi. Nie wpisuj tu hase≈Ç
                u≈ºywanych gdzie indziej.</p>
            <div class="space-y-3">
                <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN"
                    class="w-full rounded-xl px-3 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
                <button id="unlockBtn"
                    class="w-full rounded-xl px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white">Odblokuj</button>
                <p id="pinError" class="text-sm text-red-500 hidden">Nieprawid≈Çowy PIN lub dane. Spr√≥buj ponownie.</p>
            </div>
            <p class="text-[11px] text-gray-500 mt-4">Uwaga: w statycznych stronach PIN to tylko utrudnienie dostƒôpu.
                Nie publikuj danych wra≈ºliwych (imion, adres√≥w, PESEL). U≈ºywaj samych numer√≥w z dziennika i kwot.</p>
        </div>
    </div>

    <script>
        // ---- Utility: currency ----
        const fmt = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' })

        // ---- Theme toggle ----
        document.getElementById('darkToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark')
            localStorage.setItem('theme', isDark ? 'dark' : 'light')
        })

        // ---- Crypto helpers (WebCrypto) ----
        async function deriveKey(pin, salt, iterations = 120000) {
            const enc = new TextEncoder()
            const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), { name: 'PBKDF2' }, false, ['deriveKey'])
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            )
        }

        async function decryptData(pin, payload) {
            // payload: { salt: base64, iv: base64, ct: base64, iterations?: number }
            const salt = Uint8Array.from(atob(payload.salt), c => c.charCodeAt(0))
            const iv = Uint8Array.from(atob(payload.iv), c => c.charCodeAt(0))
            const ct = Uint8Array.from(atob(payload.ct), c => c.charCodeAt(0))
            const key = await deriveKey(pin, salt, payload.iterations || 120000)
            const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct)
            const txt = new TextDecoder().decode(new Uint8Array(pt))
            return JSON.parse(txt)
        }

        // ---- State ----
        let DATA = null // decrypted JSON

        function computeClosed() {
            try {
                const entries = Array.isArray(DATA?.entries) ? DATA.entries : []
                if (!entries.length) return false
                return entries.every(e => !!e.paid)
            } catch { return false }
        }

        function computeStats() {
            const entries = Array.isArray(DATA?.entries) ? DATA.entries : []
            const totalCount = entries.length
            const paidCount = entries.filter(e => !!e.paid).length
            const amountDue = Number(DATA?.fees?.amountDue || 0)
            const collected = entries.reduce((s, e) => s + Number(e.amountPaid || 0), 0)
            const expected = amountDue ? amountDue * totalCount : 0
            const outstanding = expected - collected
            const progress = expected ? Math.min(100, Math.round((collected / expected) * 100)) : (paidCount && totalCount ? Math.round((paidCount / totalCount) * 100) : 0)
            return { paidCount, totalCount, collected, expected, outstanding, progress }
        }    }

        // ---- DOM refs ----
        const pinModal = document.getElementById('pinModal')
        const pinInput = document.getElementById('pinInput')
        const unlockBtn = document.getElementById('unlockBtn')
        const pinError = document.getElementById('pinError')

        const summaryEl = document.getElementById('accountSummary')
        const resultEl = document.getElementById('result')
        const expensesWrap = document.getElementById('expensesWrap')
        const expensesEl = document.getElementById('expenses')

        const historyWrap = document.getElementById('historyWrap')
        const historyEl = document.getElementById('history')

        // Public info (aggregate receipts, totals)
        const publicInfoWrap = document.createElement('div')
        publicInfoWrap.id = 'publicInfoWrap'
        publicInfoWrap.className = 'mt-6 hidden'
        expensesWrap.insertAdjacentElement('afterend', publicInfoWrap)

        // ---- Load encrypted payload ----
        let ENCRYPTED_PAYLOAD = null
        async function fetchEncrypted() {
            // Place your encrypted file at ./data.enc.json
            const res = await fetch('./data.enc.json', { cache: 'no-store' })
            if (!res.ok) throw new Error('Nie mo≈ºna pobraƒá danych')
            ENCRYPTED_PAYLOAD = await res.json()
        }

        // ---- Renderers ----
        function renderSummary() {
            const { account, fees } = DATA
            const { paidCount, totalCount, collected, expected, outstanding, progress } = computeStats()

            // Auto-close when everyone paid
            const isClosedAuto = paidCount === totalCount && totalCount > 0
            DATA.fees.closed = typeof fees.closed === 'boolean' ? (fees.closed || isClosedAuto) : isClosedAuto

            const statusBadge = DATA.fees.closed
                ? '<span class="px-2 py-0.5 text-[11px] rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">ZAKO≈ÉCZONA</span>'
                : '<span class="px-2 py-0.5 text-[11px] rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">TRWA</span>'

            // Top summary cards
            summaryEl.innerHTML = `
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="text-xs text-gray-500">Stan konta (≈ÇƒÖcznie)</div>
          <div class="text-2xl font-semibold">${fmt.format(account.balance)}</div>
          <div class="text-xs text-gray-500 mt-1">Aktualizacja: ${account.lastUpdate}</div>
        </div>
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xs text-gray-500">Bie≈ºƒÖca sk≈Çadka</div>
              <div class="text-lg font-medium">${fees.currentPeriod || ''} ‚Ä¢ ${fmt.format(fees.amountDue || 0)}</div>
            </div>
            ${statusBadge}
          </div>
          <div class="text-sm flex gap-3 flex-wrap">
            <div><span class="text-gray-500">Wp≈Çaty:</span> <strong>${paidCount}/${totalCount}</strong></div>
            <div><span class="text-gray-500">Zebrano:</span> <strong>${fmt.format(collected)}</strong></div>
            ${expected ? `<div><span class="text-gray-500">Plan:</span> <strong>${fmt.format(expected)}</strong></div>` : ''}
            ${expected ? `<div><span class="text-gray-500">Brakuje:</span> <strong>${fmt.format(Math.max(outstanding, 0))}</strong></div>` : ''}
          </div>
          <div class="mt-2 h-2 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden" aria-label="postƒôp zbi√≥rki">
            <div class="h-full bg-blue-600 dark:bg-blue-500" style="width:${progress}%"></div>
          </div>
          ${fees.description ? `<div class="text-xs text-gray-500 mt-1">${fees.description}</div>` : ''}
        </div>`

            // Breakdown tiles (if provided)
            const breakdown = Array.isArray(account.breakdown) ? account.breakdown : []
            if (breakdown.length) {
                const grid = document.createElement('div')
                grid.className = 'sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-3'
                breakdown.forEach(item => {
                    const card = document.createElement('div')
                    card.className = 'rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm'
                    card.innerHTML = `
            <div class="text-xs text-gray-500">${item.name}</div>
            <div class="text-xl font-semibold">${fmt.format(item.balance || 0)}</div>
          `
                    grid.appendChild(card)
                })
                summaryEl.appendChild(grid)
            }

            summaryEl.style.opacity = 1
        }

        function renderChildStatus(entry) {
            resultEl.innerHTML = ''
            if (!entry) {
                resultEl.innerHTML = `<div class="rounded-2xl border border-amber-300 bg-amber-50 text-amber-900 dark:border-amber-400/40 dark:bg-amber-950/30 dark:text-amber-100 p-4">
          Nie znaleziono takiego numeru. Sprawd≈∫ wpis.
        </div>`
                return
            }

            // Per-collection status list
            const collections = Array.isArray(DATA.collections) ? DATA.collections : []
            const payments = entry.payments || {}
            const rows = collections.map(col => {
                const p = payments[col.id]
                const paid = !!(p && p.paid)
                const badge = paid
                    ? '<span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">OP≈ÅACONO</span>'
                    : '<span class="px-2 py-0.5 text-xs rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">DO ZAP≈ÅATY</span>'
                const amountPaid = Number(p?.amountPaid || 0)
                const due = Number(col.amountDue || 0)
                const remaining = Math.max(due - amountPaid, 0)
                return `
          <div class="flex items-center justify-between gap-3 py-2 border-b border-gray-200/70 dark:border-gray-800/60">
            <div>
              <div class="text-sm font-medium">${col.name} ${col.period ? `‚Ä¢ ${col.period}` : ''}</div>
              <div class="text-xs text-gray-500">${paid ? `Zap≈Çacono: <strong>${fmt.format(amountPaid)}</strong>` : `Do zap≈Çaty: <strong>${fmt.format(remaining)}</strong> (z ${fmt.format(due)})`}</div>
            </div>
            ${badge}
          </div>`
            }).join('') || '<div class="text-sm text-gray-500">Brak zdefiniowanych zbi√≥rek</div>'

            resultEl.innerHTML = `
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">Numer: ${entry.journalNo}</div>
          </div>
          <div class="mt-2">${rows}</div>
        </div>`
        }

        const paidBadge = entry.paid
            ? `<span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">OP≈ÅACONO</span>`
            : `<span class="px-2 py-0.5 text-xs rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">DO ZAP≈ÅATY</span>`

        const allocations = (entry.allocations || [])
            .map(a => `<div class="flex justify-between text-sm"><span>${a.purpose}</span><span>${fmt.format(a.amount)}</span></div>`)
            .join('') || '<div class="text-sm text-gray-500">Brak alokacji</div>'

        const receipts = (entry.receipts || [])
            .map(url => `<a class="text-blue-600 dark:text-blue-400 underline" href="${url}" target="_blank" rel="noreferrer">Paragon</a>`)
            .join(' ¬∑ ') || '<span class="text-gray-500">Brak paragon√≥w</span>'

        const dueInfo = entry.paid
            ? `<div class="text-sm text-gray-500">Zap≈Çacono: <strong>${fmt.format(entry.amountPaid || 0)}</strong> ${entry.paidOn ? `(${entry.paidOn})` : ''}</div>`
            : `<div class="text-sm text-gray-500">Do zap≈Çaty: <strong>${fmt.format((DATA.fees?.amountDue || 0) - (entry.amountPaid || 0))}</strong></div>`

        resultEl.innerHTML = `
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">Numer: ${entry.journalNo}</div>
            ${paidBadge}
          </div>
          <div class="mt-2 space-y-1">
            ${dueInfo}
            <div class="text-sm">Na co przeznaczono / przeznaczy siƒô ≈õrodki:</div>
            <div class="mt-1 space-y-0.5">${allocations}</div>
            <div class="mt-2 text-sm">Paragony: ${receipts}</div>
          </div>
        </div>`
    }

        function renderExpenses() {
            const items = DATA.expenses || []
            if (!items.length) { expensesWrap.classList.add('hidden'); return }
            expensesWrap.classList.remove('hidden')
            const total = items.reduce((s, e) => s + Number(e.amount || 0), 0)
            expensesWrap.querySelector('h2').innerHTML = `Og√≥lna informacja (wydatki i paragony) ‚Äî suma: ${fmt.format(total)}`
            expensesEl.innerHTML = items.map(e => `
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between text-sm">
            <div class="font-medium">${e.purpose}</div>
            <div>${fmt.format(e.amount)}</div>
          </div>
          ${e.receipt ? `<div class=\"text-xs\"><a class=\"text-blue-600 dark:text-blue-400 underline\" href=\"${e.receipt}\" target=\"_blank\" rel=\"noreferrer\">Paragon</a></div>` : ''}
        </div>`).join('')

            // Also render ledger/history (global transactions)
            renderHistory()
        }

        function renderHistory() {
            const ledger = Array.isArray(DATA.ledger) ? [...DATA.ledger] : []
            if (!ledger.length) { historyWrap.classList.add('hidden'); return }
            historyWrap.classList.remove('hidden')
            // Sort by ts desc if present; otherwise keep as-is
            ledger.sort((a, b) => (b.ts || 0) - (a.ts || 0))
            const kindBadge = (k) => ({
                'wp≈Çata': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200',
                'wydatek': 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200',
                'uznanie': 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-200'
            }[k] || 'bg-gray-100 text-gray-700 dark:bg-gray-800/60 dark:text-gray-200')

            historyEl.innerHTML = ledger.map(tx => {
                const badge = `<span class=\"px-2 py-0.5 text-[11px] rounded-full ${kindBadge(tx.kind)}\">${tx.kind.toUpperCase()}</span>`
                const amount = `${fmt.format(Number(tx.amount || 0))}`
                const who = tx.journalNo ? ` ‚Ä¢ nr dz.: ${tx.journalNo}` : ''
                const col = tx.collectionId ? ` ‚Ä¢ zbi√≥rka: ${getCollectionName(tx.collectionId)}` : ''
                const note = tx.note ? ` ‚Äî ${tx.note}` : ''
                const receipt = tx.receipt ? ` <a class=\"text-blue-600 dark:text-blue-400 underline\" href=\"${tx.receipt}\" target=\"_blank\" rel=\"noreferrer\">Paragon</a>` : ''
                return `
          <div class=\"rounded-xl border border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-gray-800\">
            <div class=\"flex items-center justify-between text-sm\">
              <div class=\"font-medium\">${badge} <span class=\"align-middle\">${amount}</span></div>
              <div class=\"text-xs text-gray-500\">${tx.ref || ''}</div>
            </div>
            <div class=\"text-xs text-gray-600 dark:text-gray-300 mt-1\">${(tx.purpose || '')}${who}${col}${note}${receipt}</div>
          </div>`
            }).join('')
        }

        function getCollectionName(id) {
            const c = (DATA.collections || []).find(x => x.id === id)
            return c ? c.name : id
        } expensesWrap.classList.remove('hidden')
        const total = items.reduce((s, e) => s + Number(e.amount || 0), 0)
        expensesWrap.querySelector('h2').innerHTML = `Og√≥lna informacja (wydatki i paragony) ‚Äî suma: ${fmt.format(total)}`
        expensesEl.innerHTML = items.map(e => `
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between text-sm">
            <div class="font-medium">${e.purpose}</div>
            <div>${fmt.format(e.amount)}</div>
          </div>
          <div class="text-xs text-gray-500">${e.date || ''}</div>
          ${e.receipt ? `<a class=\"text-xs text-blue-600 dark:text-blue-400 underline\" href=\"${e.receipt}\" target=\"_blank\" rel=\"noreferrer\">Paragon</a>` : ''}
        </div>`).join('')

        // Public info block combining all receipts (entries + expenses)
        const entryReceipts = (DATA.entries || []).flatMap(e => e.receipts || [])
        const expenseReceipts = items.map(e => e.receipt).filter(Boolean)
        const allReceipts = [...new Set([...entryReceipts, ...expenseReceipts])]
        const { collected, expected, outstanding } = computeStats()

        if (allReceipts.length || expected) {
            publicInfoWrap.classList.remove('hidden')
            publicInfoWrap.innerHTML = `
          <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-800 shadow-sm">
            <div class="text-base font-semibold mb-1">Publiczna informacja rozliczeniowa</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <div>Plan zbi√≥rki: <strong>${fmt.format(expected || 0)}</strong></div>
              <div>Zebrano: <strong>${fmt.format(collected || 0)}</strong></div>
              <div>Do domkniƒôcia: <strong>${fmt.format(Math.max(outstanding || 0, 0))}</strong></div>
            </div>
            ${allReceipts.length ? `<div class="mt-3 text-sm">
              <div class="text-xs text-gray-500 mb-1">Wszystkie paragony (publiczne):</div>
              <div class="flex flex-wrap gap-2">${allReceipts.map((u, i) => `<a class=\"text-blue-600 dark:text-blue-400 underline\" href=\"${u}\" target=\"_blank\" rel=\"noreferrer\">Paragon ${i + 1}</a>`).join(' ')}</div>
            </div>` : ''}
          </div>`
        }
    }
        expensesWrap.classList.remove('hidden')
        expensesEl.innerHTML = items.map(e => `
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between text-sm">
            <div class="font-medium">${e.purpose}</div>
            <div>${fmt.format(e.amount)}</div>
          </div>
          <div class="text-xs text-gray-500">${e.date || ''}</div>
          ${e.receipt ? `<a class=\"text-xs text-blue-600 dark:text-blue-400 underline\" href=\"${e.receipt}\" target=\"_blank\" rel=\"noreferrer\">Paragon</a>` : ''}
        </div>`).join('')
    }

        // ---- Events ----
        document.getElementById('checkBtn').addEventListener('click', () => {
            const val = (document.getElementById('journalNo').value || '').trim()
            if (!val) return
            const entry = (DATA.entries || []).find(e => (e.journalNo + '').toLowerCase() === val.toLowerCase())
            renderChildStatus(entry)
        })

        // Enter on PIN or on search
        pinInput.addEventListener('keydown', e => { if (e.key === 'Enter') unlockBtn.click() })
        document.getElementById('journalNo').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('checkBtn').click() })

        unlockBtn.addEventListener('click', async () => {
            pinError.classList.add('hidden')
            const pin = pinInput.value
            if (!pin) return
            try {
                if (!ENCRYPTED_PAYLOAD) await fetchEncrypted()
                DATA = await decryptData(pin, ENCRYPTED_PAYLOAD)
                if (!DATA.fees) DATA.fees = { currentPeriod: '', amountDue: 0, description: '', closed: false }
                // Auto-close based on entries
                const closedAuto = computeClosed()
                DATA.fees.closed = typeof DATA.fees.closed === 'boolean' ? (DATA.fees.closed || closedAuto) : closedAuto
                pinModal.remove()
                renderSummary()
                renderExpenses()
            } catch (e) {
                console.error(e)
                pinError.classList.remove('hidden')
            }
        })

        // Optional: auto-focus
        setTimeout(() => pinInput.focus(), 100)

    </script>
</body>

</html>